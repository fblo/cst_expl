# Containerfile Multi-Stage pour CCCP Dashboard
# Stage 1: Build du binaire cccenter_report
FROM fedora:39 AS builder

LABEL maintainer="ccc_report_build"
LABEL description="Builder for cccenter_report binary with glibc 2.38+"
LABEL version="1.0"

# Variables d'environnement pour le build
ENV CC=gcc
ENV CXX=g++
ENV CFLAGS="-O2 -g -D_UNIX_ -DCCENTER_REPORT"
ENV CXXFLAGS="-O2 -g -std=c++03 -D_UNIX_ -DCCENTER_REPORT"
ENV LDFLAGS="-lcrypt"
ENV MAKEFLAGS="-j$(nproc)"

# Installation des outils de build
RUN dnf update -y && \
    dnf groupinstall -y "Development Tools" && \
    dnf install -y \
        gcc \
        gcc-c++ \
        make \
        cmake \
        libxcrypt \
        libxcrypt-devel \
        libxml2-devel \
        libxslt-devel \
        zlib-devel \
        openssl-devel \
        which \
        wget \
        curl \
        git && \
    dnf clean all

# Créer le lien symbolique pour libcrypt.so.2
RUN ln -sf /lib64/libcrypt.so.1 /lib64/libcrypt.so.2 && \
    ldconfig

# Création des répertoires de build
RUN mkdir -p /opt/consistent/bin

# Copier les sources essentiels uniquement
WORKDIR /opt/consistent
COPY --from=local ./main.C ./
COPY --from=local ./report.C ./
COPY --from=local ./report.h ./
COPY --from=local ./explorer_client.C ./
COPY --from=local ./explorer_client.h ./
COPY --from=local ./forward_declarations.hpp ./
COPY --from=local ./common/ ./common/
COPY --from=local ./public/ccenter_system.h ./public/
COPY --from=local ./public/ccenter_system.cpp ./public/
COPY --from=local ./public/ccenter_public.h ./public/
COPY --from=local ./public/ccenter_version.h ./public/
COPY --from=local ./idl/ ./idl/
COPY --from=local ./rules.mk ./

# Créer un Makefile minimal pour le build
RUN cat > Makefile << 'EOF'
# Makefile minimal pour cccenter_report
CC = gcc
CXX = g++
CFLAGS = -O2 -g -D_UNIX_ -DCCENTER_REPORT -I. -Icommon -Ipublic -Iidl
CXXFLAGS = -O2 -g -std=c++03 -D_UNIX_ -DCCENTER_REPORT -I. -Icommon -Ipublic -Iidl
LDFLAGS = -lcrypt

# Sources
SOURCES = main.C report.C explorer_client.C public/ccenter_system.cpp
OBJECTS = $(SOURCES:.C=.o)
TARGET = cccenter_report

# Règles
all: $(TARGET)

$(TARGET): $(OBJECTS)
	$(CXX) $(OBJECTS) $(LDFLAGS) -o $@

%.o: %.C
	$(CXX) $(CXXFLAGS) -c $< -o $@

clean:
	rm -f $(OBJECTS) $(TARGET)

.PHONY: all clean
EOF

# Build du binaire
RUN make -j$(nproc)

# Créer les répertoires finaux
RUN mkdir -p /opt/consistent/bin && \
    cp cccenter_report /opt/consistent/bin/ && \
    chmod +x /opt/consistent/bin/cccenter_report

# Vérifier le binaire
RUN /opt/consistent/bin/cccenter_report --version 2>/dev/null || echo "Binary created successfully"

# =============================================================================
# Stage 2: Conteneur Final avec Dashboard Web
FROM fedora:39 AS runtime

LABEL maintainer="ccc_report_dashboard"
LABEL description="CCCP Dashboard Web Server with integrated cccenter_report"
LABEL version="1.0"

# Installation des dépendances Python et système
RUN dnf update -y && \
    dnf install -y \
        python3 \
        python3-pip \
        python3-devel \
        mysql \
        mysql-connector-c \
        mysql-connector-c++ \
        libmysqlclient \
        libxml2 \
        libxml2-devel \
        libxslt \
        libxslt-devel \
        zlib \
        zlib-devel \
        openssl \
        openssl-devel \
        libxcrypt \
        libxcrypt-devel \
        curl \
        wget \
        git && \
    dnf clean all

# Créer le lien symbolique pour libcrypt.so.2
RUN ln -sf /lib64/libcrypt.so.1 /lib64/libcrypt.so.2 && \
    ldconfig

# Installation des packages Python
RUN pip3 install --no-cache-dir \
        flask>=2.0.0 \
        flask-cors>=3.0.0 \
        mysql-connector-python>=8.0.0

# Créer la structure des répertoires
RUN mkdir -p /app/{templates,logs,config}

# Copier le binaire depuis le stage builder
COPY --from=builder /opt/consistent/bin/ccenter_report /usr/local/bin/ccenter_report
RUN chmod +x /usr/local/bin/ccenter_report

# Copier les fichiers de l'application web
WORKDIR /app
COPY web_server.py ./
COPY get_users_and_calls.py ./
COPY requirements.txt ./
COPY templates/ ./templates/

# Créer un fichier de configuration par défaut
RUN cat > config.py << 'EOF'
#!/usr/bin/env python3
"""
Configuration par défaut pour CCCP Dashboard
Peut être surchargé avec des variables d'environnement
"""
import os

# Configuration base de données (externe)
MYSQL_CONFIG = {
    "host": os.getenv("MYSQL_HOST", "vs-ics-prd-web-fr-505"),
    "user": os.getenv("MYSQL_USER", "interactiv"),
    "password": os.getenv("MYSQL_PASSWORD", "ics427!"),
    "database": os.getenv("MYSQL_DATABASE", None),
    "charset": "utf8",
    "collation": "utf8_general_ci",
}

# Configuration par défaut des serveurs CCCP
DEFAULT_SERVER_IP = os.getenv("DEFAULT_SERVER_IP", "10.199.30.67")
DEFAULT_SERVER_PORT = int(os.getenv("DEFAULT_SERVER_PORT", "20103"))

# Configuration de l'application
FLASK_HOST = os.getenv("FLASK_HOST", "0.0.0.0")
FLASK_PORT = int(os.getenv("FLASK_PORT", 5000))
FLASK_DEBUG = os.getenv("FLASK_DEBUG", "False").lower() == "true"

# Logging
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")

print(f"Configuration chargée:")
print(f"  MySQL: {MYSQL_CONFIG['host']}:{MYSQL_CONFIG['port'] if 'port' in MYSQL_CONFIG else '3306'}")
print(f"  Serveur par défaut: {DEFAULT_SERVER_IP}:{DEFAULT_SERVER_PORT}")
print(f"  Flask: {FLASK_HOST}:{FLASK_PORT}")
EOF

# Variables d'environnement par défaut
ENV FLASK_HOST=0.0.0.0
ENV FLASK_PORT=5000
ENV FLASK_DEBUG=false
ENV LOG_LEVEL=INFO
ENV MYSQL_HOST=vs-ics-prd-web-fr-505
ENV MYSQL_USER=interactiv
ENV MYSQL_PASSWORD=ics427!
ENV DEFAULT_SERVER_IP=10.199.30.67
ENV DEFAULT_SERVER_PORT=20103

# Exposer les ports
EXPOSE 5000

# Point d'entrée
CMD ["python3", "web_server.py"]

# =============================================================================
# Étiquettes pour le multi-stage
LABEL stage="runtime"
LABEL purpose="cccp-dashboard"