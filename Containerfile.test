FROM fedora:39 AS runtime

LABEL maintainer="ccc_report_dashboard"
LABEL description="CCCP Dashboard Web Server with integrated ccenter_report"
LABEL version="1.0"

# Installation des dépendances Python et système
RUN dnf update -y && \
    dnf install -y \
        python3 \
        python3-pip \
        python3-devel \
        mysql \
        mariadb-connector-c \
        libxml2 \
        libxml2-devel \
        libxslt \
        libxslt-devel \
        zlib \
        zlib-devel \
        openssl \
        openssl-devel \
        libxcrypt \
        libxcrypt-devel \
        curl \
        wget \
        git && \
    dnf clean all

# Créer le lien symbolique pour libcrypt.so.2
RUN ln -sf /lib64/libcrypt.so.1 /lib64/libcrypt.so.2 && \
    ldconfig

# Installation des packages Python
RUN pip3 install --no-cache-dir \
        flask>=2.0.0 \
        flask-cors>=3.0.0 \
        mysql-connector-python>=8.0.0

# Créer la structure des répertoires
RUN mkdir -p /app/{templates,logs,config}

# Copier le binaire depuis le stage builder
COPY ccenter_report /app

# Copier les fichiers de l'application web
WORKDIR /app
COPY web_server.py ./
COPY get_users_and_calls.py ./
COPY requirements.txt ./
COPY templates/ ./templates/

# Créer un fichier de configuration par défaut
RUN cat > config.py << 'EOF'
#!/usr/bin/env python3
"""
Configuration par défaut pour CCCP Dashboard
Peut être surchargé avec des variables d'environnement
"""
import os

# Configuration base de données (externe)
MYSQL_CONFIG = {
    "host": os.getenv("MYSQL_HOST", "vs-ics-prd-web-fr-505"),
    "user": os.getenv("MYSQL_USER", "interactiv"),
    "password": os.getenv("MYSQL_PASSWORD", "ics427!"),
    "database": os.getenv("MYSQL_DATABASE", None),
    "charset": "utf8",
    "collation": "utf8_general_ci",
}

# Configuration par défaut des serveurs CCCP
DEFAULT_SERVER_IP = os.getenv("DEFAULT_SERVER_IP", "10.199.30.67")
DEFAULT_SERVER_PORT = int(os.getenv("DEFAULT_SERVER_PORT", "20103"))

# Configuration de l'application
FLASK_HOST = os.getenv("FLASK_HOST", "0.0.0.0")
FLASK_PORT = int(os.getenv("FLASK_PORT", 5000))
FLASK_DEBUG = os.getenv("FLASK_DEBUG", "False").lower() == "true"

# Logging
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")

print(f"Configuration chargée:")
print(f"  MySQL: {MYSQL_CONFIG['host'] if 'port' in MYSQL_CONFIG else '3306'}")
print(f"  Serveur par défaut: {DEFAULT_SERVER_IP}:{DEFAULT_SERVER_PORT}")
print(f"  Flask: {FLASK_HOST}:{FLASK_PORT}")
EOF

# Variables d'environnement par défaut
ENV FLASK_HOST=0.0.0.0
ENV FLASK_PORT=5000
ENV FLASK_DEBUG=false
ENV LOG_LEVEL=INFO
ENV MYSQL_HOST=vs-ics-prd-web-fr-505
ENV MYSQL_USER=interactiv
ENV MYSQL_PASSWORD=ics427!
ENV DEFAULT_SERVER_IP=10.199.30.67
ENV DEFAULT_SERVER_PORT=20103

# Exposer les ports
EXPOSE 5000

# Point d'entrée
CMD ["python3", "web_server.py"]

