<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logs Explorer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÅ</text></svg>">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-color: #58a6ff;
            --accent-hover: #79c0ff;
            --success-bg: #23863644;
            --success-color: #3fb950;
            --warning-bg: #d2992244;
            --warning-color: #d29922;
            --error-bg: #da363344;
            --error-color: #f85149;
            --purple-color: #cba6f7;
            --input-bg: #0d1117;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #edeff1;
            --border-color: #d0d7de;
            --text-primary: #24292f;
            --text-secondary: #57606a;
            --text-muted: #8b949e;
            --accent-color: #0969da;
            --accent-hover: #0550ae;
            --success-bg: #dafbe1;
            --success-color: #1a7f37;
            --warning-bg: #fff8c5;
            --warning-color: #9a6700;
            --error-bg: #ffebe9;
            --error-color: #cf222e;
            --purple-color: #8250df;
            --input-bg: #f6f8fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 12px;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 12px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 12px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-color);
        }
        .selector-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .selector-group label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .selector-group select,
        .selector-group input {
            padding: 6px 10px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            min-width: 200px;
        }
        .selector-group input {
            width: 120px;
        }
        .selector-group select:focus,
        .selector-group input:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        .theme-selector {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .theme-selector label {
            font-size: 11px;
            color: var(--text-muted);
        }
        .theme-selector select {
            padding: 4px 8px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 11px;
            cursor: pointer;
        }
        .status-bar {
            display: flex;
            gap: 24px;
            font-size: 12px;
        }
        .status-item {
            display: flex;
            gap: 6px;
        }
        .status-item span:first-child {
            color: var(--text-muted);
        }
        .status-item span:last-child {
            color: var(--text-primary);
            font-weight: 500;
        }
        .main-content {
            display: flex;
            flex: 1;
            gap: 12px;
            overflow: hidden;
        }
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .panel-logs {
            flex: 1;
            min-width: 300px;
            max-width: 400px;
        }
        .panel-sessions {
            flex: 2;
        }
        .panel-header {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .panel-header .count {
            background: var(--bg-primary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            color: var(--text-muted);
        }
        .panel-content {
            flex: 1;
            overflow-y: auto;
        }
        .panel-content::-webkit-scrollbar {
            width: 8px;
        }
        .panel-content::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        .panel-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        .empty {
            color: var(--text-muted);
            text-align: center;
            padding: 40px 20px;
            font-size: 13px;
        }
        .log-file {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .log-file:hover {
            background: var(--bg-tertiary);
        }
        .log-file.selected {
            background: var(--accent-color);
            color: white;
        }
        .log-name {
            font-size: 11px;
            word-break: break-all;
        }
        .log-info {
            display: flex;
            gap: 8px;
            font-size: 10px;
            color: var(--text-muted);
        }
        .log-size {
            color: var(--success-color);
        }
        .log-compressed {
            color: var(--warning-color);
        }
        .sessions-toolbar {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }
        .sessions-toolbar input {
            flex: 1;
            padding: 6px 10px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 12px;
        }
        .sessions-toolbar select {
            padding: 6px 10px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 12px;
        }
        .sessions-header {
            display: grid;
            grid-template-columns: 140px 120px 120px 1fr;
            gap: 0;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }
        .sessions-header div {
            padding: 8px 12px;
            border-right: 1px solid var(--border-color);
        }
        .sessions-header div:last-child {
            border-right: none;
        }
        .session-item {
            display: grid;
            grid-template-columns: 140px 120px 120px 1fr;
            gap: 0;
            border-bottom: 1px solid var(--border-color);
            line-height: 1.5;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .session-item:hover {
            background: var(--bg-tertiary);
        }
        .session-item.selected {
            background: var(--accent-color);
            color: white;
        }
        .session-item div {
            padding: 8px 12px;
            border-right: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .session-item div:last-child {
            border-right: none;
        }
        .session-time { color: var(--text-muted); }
        .session-id { color: var(--accent-color); }
        .session-caller { color: var(--success-color); font-weight: 500; }
        .session-called { color: var(--warning-color); font-weight: 500; }
        .controls {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 12px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 6px 14px;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .btn:hover {
            background: var(--border-color);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
            color: white;
        }
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .progress-bar {
            height: 3px;
            background: var(--bg-tertiary);
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s;
        }
        .file-list-header {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .file-list-header div:nth-child(1) { flex: 1; }
        .file-list-header div:nth-child(2) { width: 60px; text-align: right; }
        .file-list-header div:nth-child(3) { width: 50px; text-align: right; }
        .log-file > div:nth-child(1) { flex: 1; }
        .log-file > div:nth-child(2) { width: 60px; text-align: right; }
        .log-file > div:nth-child(3) { width: 50px; text-align: right; }
        .nfs-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .nfs-available {
            background: var(--success-bg);
            color: var(--success-color);
        }
        .nfs-unavailable {
            background: var(--error-bg);
            color: var(--error-color);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            gap: 16px;
            flex-wrap: wrap;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
            min-width: 300px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-color);
            white-space: nowrap;
        }
        .selector-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .selector-group label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .selector-group select,
        .selector-group input {
            padding: 4px 8px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 11px;
        }
        .global-search {
            display: flex;
            gap: 6px;
        }
        .global-search input {
            padding: 4px 8px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 11px;
            width: 250px;
        }
        .global-search input:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        .global-search-results {
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }
        .global-search-results .panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .global-search-results .panel-header button {
            margin-left: auto;
        }
    </style>
</head>
<body data-theme="dark">
    <div class="container">
        <div class="header">
            <div class="header-left">
                <span class="title">üìÅ Logs Explorer</span>
                
                <div class="selector-group">
                    <label>Project</label>
                    <select id="projectSelect" onchange="onProjectChange()">
                        <option value="">Select project...</option>
                    </select>
                </div>
                
                <div class="selector-group">
                    <label>Date</label>
                    <input type="date" id="dateInput" onchange="onDateChange()">
                </div>
                
                <div id="nfsStatus" class="nfs-status nfs-unavailable">
                    <span>NFS unavailable</span>
                </div>
            </div>

            <div class="header-center">
                <div class="global-search">
                    <input type="text" id="globalSearch" placeholder="üîç Num√©ro, projet, date..." onkeypress="if(event.key==='Enter') performGlobalSearch()">
                    <button class="btn" onclick="performGlobalSearch()" id="globalSearchBtn">Rechercher</button>
                </div>
            </div>

            <div class="header-right">
                <div class="theme-selector">
                    <label for="theme-select">Theme:</label>
                    <select id="theme-select" onchange="changeTheme()">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                    </select>
                </div>
                <div class="status-bar">
                    <div class="status-item">
                        <span>Logs</span>
                        <span id="logCount">0</span>
                    </div>
                    <div class="status-item">
                        <span>Sessions</span>
                        <span id="sessionCount">0</span>
                    </div>
                    <div class="status-item">
                        <span>Dispatches</span>
                        <span id="dispatchCount">0</span>
                    </div>
                    <div class="status-item">
                        <span>Status</span>
                        <span id="statusText">Ready</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
        </div>

        <div class="global-search-results" id="globalSearchResults" style="display: none;">
            <div class="panel-header">
                <span>R√©sultats de recherche globale</span>
                <span class="count" id="globalSearchCount">0</span>
                <button class="btn btn-small" onclick="closeGlobalSearch()">‚úï</button>
            </div>
            <div class="sessions-header">
                <div class="col-date">Projet</div>
                <div class="col-date">Date</div>
                <div class="col-caller">Caller</div>
                <div class="col-called">Called</div>
                <div class="col-id">Session</div>
            </div>
            <div class="panel-content" id="globalSearchPanel">
            </div>
        </div>

        <div class="main-content">
            <div class="panel panel-logs">
                <div class="panel-header">
                    <span>Log Files</span>
                    <span class="count" id="logsPanelCount">0</span>
                </div>
                <div class="file-list-header">
                    <div>Name</div>
                    <div>Size</div>
                    <div>Type</div>
                </div>
                <div class="panel-content" id="logsPanel">
                    <div class="empty">Select a project and date to load logs</div>
                </div>
            </div>
            
            <div class="panel panel-sessions">
                <div class="panel-header">
                    <span>Call Sessions</span>
                    <span class="count" id="sessionsPanelCount">0</span>
                </div>
                <div class="sessions-toolbar">
                    <input type="text" id="phoneSearch" placeholder="üîç Rechercher un num√©ro..." oninput="filterSessions()">
                    <select id="sortSessions" onchange="filterSessions()">
                        <option value="date_desc">Date ‚Üì</option>
                        <option value="date_asc">Date ‚Üë</option>
                        <option value="caller">Caller</option>
                        <option value="called">Called</option>
                    </select>
                </div>
                <div class="sessions-header">
                    <div class="col-date">Date</div>
                    <div class="col-caller">Caller</div>
                    <div class="col-called">Called</div>
                    <div class="col-id">Session</div>
                </div>
                <div class="panel-content" id="sessionsPanel">
                    <div class="empty">No sessions loaded</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" id="retrieveBtn" onclick="retrieveLogs()" disabled>
                Retrieve Logs
            </button>
            <button class="btn" onclick="loadSessions()" id="loadSessionsBtn" disabled>
                Load Sessions
            </button>
            <button class="btn" onclick="openSessionConsole()" id="consoleBtn" disabled>
                Open Console
            </button>
            <button class="btn" onclick="refreshProjectList()">
                Refresh Projects
            </button>
            <span style="flex: 1"></span>
            <button class="btn" onclick="window.close()">Close</button>
        </div>
    </div>

    <script>
        let projects = [];
        let availableDates = [];
        let localLogs = [];
        let sessions = {};
        let selectedLogFile = null;
        let selectedSession = null;
        let retrieveJobId = null;
        let pollInterval = null;

        function changeTheme() {
            const select = document.getElementById('theme-select');
            const theme = select.value;
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('logs_explorer_theme', theme);
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('logs_explorer_theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-select').value = savedTheme;
        }

        function setStatus(text, progress = 0) {
            const statusEl = document.getElementById('statusText');
            const progressEl = document.getElementById('progressBar');

            if (progress > 0) {
                statusEl.innerHTML = '<span class="loading"></span> ' + text;
                progressEl.style.width = progress + '%';
            } else {
                statusEl.textContent = text;
                progressEl.style.width = progress + '%';
            }
        }

        async function refreshDispatchStatus() {
            try {
                const res = await fetch('/api/dispatches');
                const data = await res.json();

                if (data.success) {
                    const dispatchCount = document.getElementById('dispatchCount');
                    dispatchCount.textContent = data.count || 0;
                }
            } catch (e) {
                console.warn('Could not fetch dispatch status:', e.message);
            }
        }

        async function refreshProjectList() {
            setStatus('Loading projects...', 30);
            try {
                const res = await fetch('/api/logs/projects');
                const data = await res.json();
                
                if (data.success) {
                    projects = data.projects || [];
                    renderProjectSelect();
                    setStatus(`Loaded ${projects.length} projects`);
                } else {
                    setStatus('Error loading projects');
                }
            } catch (e) {
                setStatus('Error: ' + e.message);
            }
        }

        function renderProjectSelect() {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '<option value="">Select project...</option>';
            
            projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                select.appendChild(opt);
            });
        }

        async function onProjectChange() {
            const project = document.getElementById('projectSelect').value;
            const dateInput = document.getElementById('dateInput');
            
            selectedLogFile = null;
            selectedSession = null;
            
            document.getElementById('retrieveBtn').disabled = true;
            document.getElementById('loadSessionsBtn').disabled = true;
            document.getElementById('consoleBtn').disabled = true;
            
            document.getElementById('logsPanel').innerHTML = '<div class="empty">Select a date</div>';
            document.getElementById('sessionsPanel').innerHTML = '<div class="empty">No sessions loaded</div>';
            document.getElementById('logCount').textContent = '0';
            document.getElementById('sessionCount').textContent = '0';
            document.getElementById('logsPanelCount').textContent = '0';
            document.getElementById('sessionsPanelCount').textContent = '0';
            
            if (!project) {
                dateInput.value = '';
                dateInput.disabled = true;
                updateNfsStatus(false);
                return;
            }

            setStatus('Loading dates...', 30);
            
            try {
                const res = await fetch(`/api/logs/dates?project=${encodeURIComponent(project)}`);
                const data = await res.json();
                
                if (data.success) {
                    availableDates = data.dates || [];
                    updateNfsStatus(data.nfs_available);
                    
                    if (availableDates.length > 0) {
                        dateInput.disabled = false;
                        dateInput.value = availableDates[0].date;
                        onDateChange();
                    } else {
                        dateInput.disabled = true;
                        updateNfsStatus(false);
                        setStatus('No dates available');
                    }
                } else {
                    updateNfsStatus(false);
                    setStatus('Error: ' + (data.error || 'unknown'));
                }
            } catch (e) {
                updateNfsStatus(false);
                setStatus('Error: ' + e.message);
            }
        }

        function updateNfsStatus(available) {
            const statusEl = document.getElementById('nfsStatus');
            if (available) {
                statusEl.className = 'nfs-status nfs-available';
                statusEl.innerHTML = '<span>NFS available</span>';
            } else {
                statusEl.className = 'nfs-status nfs-unavailable';
                statusEl.innerHTML = '<span>NFS unavailable</span>';
            }
        }

        async function onDateChange() {
            const project = document.getElementById('projectSelect').value;
            const date = document.getElementById('dateInput').value;
            
            selectedLogFile = null;
            selectedSession = null;
            
            document.getElementById('retrieveBtn').disabled = true;
            document.getElementById('loadSessionsBtn').disabled = true;
            document.getElementById('consoleBtn').disabled = true;
            
            if (!project || !date) {
                document.getElementById('logsPanel').innerHTML = '<div class="empty">Select project and date</div>';
                return;
            }

            setStatus('Checking local logs...', 30);
            
            try {
                const res = await fetch('/api/logs/local');
                const data = await res.json();
                
                if (data.success) {
                    localLogs = data.files || [];
                    renderLocalLogs(project, date);
                }
            } catch (e) {
                setStatus('Error checking local logs');
            }
        }

        function renderLocalLogs(project, date) {
            const panel = document.getElementById('logsPanel');
            const datePattern = date.replace(/-/g, '_');
            
            const filteredLogs = localLogs.filter(f => 
                f.date === date && 
                f.path.includes(`/${project}/`)
            );

            if (filteredLogs.length === 0) {
                panel.innerHTML = '<div class="empty">No local logs for this date.<br>Click "Retrieve Logs" to copy from NFS.</div>';
                document.getElementById('retrieveBtn').disabled = false;
                document.getElementById('logCount').textContent = '0';
                document.getElementById('logsPanelCount').textContent = '0';
                setStatus('Ready to retrieve logs');
            } else {
                panel.innerHTML = '';
                filteredLogs.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'log-file';
                    div.innerHTML = `
                        <div class="log-name">${f.name}</div>
                        <div class="log-info">
                            <span class="log-size">${formatSize(f.size)}</span>
                            <span class="log-compressed">${f.compressed ? 'BZ2' : ''}</span>
                        </div>
                    `;
                    div.onclick = () => selectLogFile(f, div);
                    panel.appendChild(div);
                });
                document.getElementById('logCount').textContent = filteredLogs.length;
                document.getElementById('logsPanelCount').textContent = filteredLogs.length;
                document.getElementById('retrieveBtn').disabled = false;
                setStatus(`Found ${filteredLogs.length} local logs`);
            }
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function selectLogFile(file, el) {
            document.querySelectorAll('.log-file').forEach(f => f.classList.remove('selected'));
            el.classList.add('selected');
            selectedLogFile = file;
            
            document.getElementById('loadSessionsBtn').disabled = false;
        }

        async function retrieveLogs() {
            const project = document.getElementById('projectSelect').value;
            const date = document.getElementById('dateInput').value;
            
            if (!project || !date) return;

            setStatus('Starting retrieval...', 10);
            document.getElementById('retrieveBtn').disabled = true;

            try {
                const res = await fetch('/api/logs/retrieve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project: project,
                        dates: [date]
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    retrieveJobId = data.job_id;
                    pollRetrieveJob();
                } else {
                    setStatus('Error: ' + (data.error || 'unknown'));
                    document.getElementById('retrieveBtn').disabled = false;
                }
            } catch (e) {
                setStatus('Error: ' + e.message);
                document.getElementById('retrieveBtn').disabled = false;
            }
        }

        async function pollRetrieveJob() {
            if (!retrieveJobId) return;

            try {
                const res = await fetch(`/api/logs/retrieve/status/${retrieveJobId}`);
                const data = await res.json();

                if (data.status === 'done') {
                    setStatus(`Retrieved ${data.copied} files`, 100);
                    onDateChange();
                    document.getElementById('retrieveBtn').disabled = false;
                } else if (data.status === 'error') {
                    setStatus('Error: ' + (data.error || 'unknown'));
                    document.getElementById('retrieveBtn').disabled = false;
                } else {
                    setStatus(data.progress || 'Processing...', 50);
                    setTimeout(pollRetrieveJob, 1000);
                }
            } catch (e) {
                setStatus('Error: ' + e.message);
                document.getElementById('retrieveBtn').disabled = false;
            }
        }

        async function loadSessions() {
            const date = document.getElementById('dateInput').value;

            if (!date) return;

            setStatus('Loading sessions...', 30);
            document.getElementById('loadSessionsBtn').disabled = true;

            try {
                const res = await fetch(`/api/rlog/sessions?date=${date}`);
                const data = await res.json();

                if (data.success) {
                    sessions = data.sessions || {};
                    window._allSessions = sessions;  // Store for global search navigation
                    renderSessions();
                    setStatus(`Loaded ${Object.keys(sessions).length} sessions`);
                } else {
                    setStatus('Error: ' + (data.error || 'unknown'));
                }
            } catch (e) {
                setStatus('Error: ' + e.message);
            } finally {
                document.getElementById('loadSessionsBtn').disabled = false;
            }
        }

        function renderSessions() {
            const panel = document.getElementById('sessionsPanel');
            panel.innerHTML = '';

            const searchTerm = document.getElementById('phoneSearch').value.toLowerCase();
            const sortBy = document.getElementById('sortSessions').value;

            let sessionList = Object.values(sessions);

            // Filter by phone number
            if (searchTerm) {
                sessionList = sessionList.filter(s =>
                    (s.caller && s.caller.toLowerCase().includes(searchTerm)) ||
                    (s.called && s.called.toLowerCase().includes(searchTerm)) ||
                    (s.id && s.id.toLowerCase().includes(searchTerm))
                );
            }

            // Sort sessions
            sessionList.sort((a, b) => {
                switch (sortBy) {
                    case 'date_asc':
                        return (a.create_date || '').localeCompare(b.create_date || '');
                    case 'date_desc':
                        return (b.create_date || '').localeCompare(a.create_date || '');
                    case 'caller':
                        return (a.caller || '').localeCompare(b.caller || '');
                    case 'called':
                        return (a.called || '').localeCompare(b.called || '');
                    default:
                        return 0;
                }
            });

            if (sessionList.length === 0) {
                const msg = searchTerm
                    ? `Aucune session trouv√©e pour "${searchTerm}"`
                    : 'No sessions found for this date';
                panel.innerHTML = `<div class="empty">${msg}</div>`;
                document.getElementById('sessionCount').textContent = '0';
                document.getElementById('sessionsPanelCount').textContent = '0';
                return;
            }

            sessionList.forEach(s => {
                const div = document.createElement('div');
                div.className = 'session-item';
                div.innerHTML = `
                    <div class="session-time">${s.create_date || '-'}</div>
                    <div class="session-caller">${s.caller || '-'}</div>
                    <div class="session-called">${s.called || '-'}</div>
                    <div class="session-id" title="${s.id}">${s.id}</div>
                `;
                div.onclick = () => selectSession(s, div);
                panel.appendChild(div);
            });

            document.getElementById('sessionCount').textContent = sessionList.length;
            document.getElementById('sessionsPanelCount').textContent = sessionList.length;
        }

        function filterSessions() {
            renderSessions();
        }

        async function performGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value.trim();

            if (!searchTerm) {
                closeGlobalSearch();
                return;
            }

            setStatus(`üîç Recherche globale: "${searchTerm}"...`);

            try {
                const res = await fetch(`/api/rlog/search?term=${encodeURIComponent(searchTerm)}`);
                const data = await res.json();

                if (data.success) {
                    renderGlobalSearchResults(data.results || []);
                    setStatus(`üîç ${data.count || 0} r√©sultats pour "${searchTerm}"`);
                } else {
                    setStatus('Erreur: ' + (data.error || 'inconnue'));
                }
            } catch (e) {
                setStatus('Erreur: ' + e.message);
            }
        }

        function renderGlobalSearchResults(results) {
            const panel = document.getElementById('globalSearchPanel');
            const container = document.getElementById('globalSearchResults');
            const countEl = document.getElementById('globalSearchCount');

            countEl.textContent = results.length;

            if (results.length === 0) {
                panel.innerHTML = '<div class="empty">Aucun r√©sultat trouv√©</div>';
                container.style.display = 'block';
                return;
            }

            panel.innerHTML = '';

            results.forEach(r => {
                const div = document.createElement('div');
                div.className = 'session-item';
                div.innerHTML = `
                    <div class="session-time">${r.project || '-'}</div>
                    <div class="session-time">${r.date || '-'}</div>
                    <div class="session-caller">${r.caller || '-'}</div>
                    <div class="session-called">${r.called || '-'}</div>
                    <div class="session-id" title="${r.id}">${r.id}</div>
                `;
                div.onclick = () => {
                    // Select project and date, then show session
                    document.getElementById('projectSelect').value = r.project;
                    onProjectChange().then(() => {
                        document.getElementById('dateInput').value = r.date;
                        onDateChange().then(() => {
                            // Load sessions and find the one
                            loadSessions().then(() => {
                                sessions = window._allSessions || {};
                                const session = sessions[r.id];
                                if (session) {
                                    selectedSession = session;
                                    document.getElementById('consoleBtn').disabled = false;
                                }
                            });
                        });
                    });
                    closeGlobalSearch();
                };
                panel.appendChild(div);
            });

            container.style.display = 'block';
        }

        function closeGlobalSearch() {
            document.getElementById('globalSearchResults').style.display = 'none';
            document.getElementById('globalSearch').value = '';
        }

        // Store all sessions for navigation
        window._allSessions = {};

        function selectSession(session, el) {
            document.querySelectorAll('.session-item').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected');
            selectedSession = session;
            document.getElementById('consoleBtn').disabled = false;
        }

        function openSessionConsole() {
            if (!selectedSession) return;
            
            const date = document.getElementById('dateInput').value;
            const sessionId = selectedSession.id;
            
            window.open(
                `/rlog_console?session=${encodeURIComponent(sessionId)}&date=${date}`,
                `console_${sessionId}`,
                'width=1200,height=800,menubar=no,toolbar=no,location=no,status=no'
            );
        }

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            refreshProjectList();
            refreshDispatchStatus();
            setInterval(refreshDispatchStatus, 10000);

            const dateInput = document.getElementById('dateInput');
            const today = new Date().toISOString().split('T')[0];
            dateInput.max = today;
        });
    </script>
</body>
</html>
